{% extends 'admin_base.html' %}

{% block title %}Manage Customers - Roasted Route{% endblock %}

{% block nav_customers_active %}active{% endblock %}

{% block page_header %}Customer Management{% endblock %}

{% block extra_head %}
<style>
    :root { 
        --red:#DC2626; 
        --yellow:#F59E0B; 
        --white:#fff; 
        --gray-50:#F9FAFB; 
        --gray-100:#F3F4F6; 
        --gray-200:#E5E7EB; 
        --gray-600:#4B5563; 
        --gray-700:#374151; 
        --gray-900:#111827; 
    }

    .customer-page-wrapper {
        background: linear-gradient(135deg, var(--gray-50), var(--gray-100)); 
        color: var(--gray-900); 
        border-radius: 12px;
        padding: 0;
    }

    .customer-card { background:var(--white); border:1px solid var(--gray-100); border-radius:16px; padding:1.5rem; box-shadow:0 4px 12px rgba(0,0,0,.05); margin-bottom:1rem; transition:all 0.3s; }
    .customer-card:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,.1); }
    
    .customer-header { display:flex; justify-content:space-between; align-items:start; margin-bottom:1rem; }
    .customer-name { font-weight:700; font-size:1.1rem; color:var(--gray-900); }
    .customer-email { color:var(--gray-600); font-size:.9rem; }
    .customer-date { color:var(--gray-500); font-size:.85rem; }
    
    .badge-role { border-radius:999px; padding:6px 12px; font-weight:600; font-size:.8rem; text-transform:uppercase; }
    .badge-staff{ background:#dcfce7;color:#065f46; }
    .badge-superuser{ background:#fef3c7;color:#92400e; }
    .badge-customer{ background:#e0f2fe;color:#075985; }
    
    .customer-stats { display:flex; gap:1rem; margin-top:1rem; padding-top:1rem; border-top:1px solid var(--gray-100); }
    .stat-item { text-align:center; }
    .stat-number { font-weight:800; font-size:1.2rem; color:var(--red); }
    .stat-label { color:var(--gray-600); font-size:.8rem; }
    
    .search-section { background:var(--white); border-radius:12px; padding:1.5rem; margin-bottom:2rem; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .search-input { border-radius:8px; border:1px solid var(--gray-200); padding:0.75rem 1rem; font-size:.95rem; }
    .search-input:focus { border-color:var(--red); box-shadow:0 0 0 3px rgba(220,38,38,.1); }
    
    .empty-state { text-align:center; padding:60px 20px; }
    .empty-state i { font-size:4rem; color:var(--gray-400); margin-bottom:20px; }
    .empty-state h4 { color:var(--gray-600); margin-bottom:12px; }
    .empty-state p { color:var(--gray-500); margin-bottom:24px; }
</style>
{% endblock %}

{% block content %}
<div class="customer-page-wrapper">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="m-0"><i class="fas fa-users me-2"></i>Customer Management</h2>
            <div class="text-muted">
                <i class="fas fa-user me-1"></i>{{ customers|length }} Total Customers
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="row align-items-center">
                <div class="col-12">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0 search-input" id="customerSearch" placeholder="Search customers by name, email...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Customers List -->
        {% if customers %}
            <div class="customers-container mt-3">
                {% for customer in customers %}
                <div class="customer-card" data-name="{{ customer.username|lower }}" data-email="{{ customer.email|lower }}">
                    <div class="customer-header">
                        <div>
                            <div class="customer-name">
                                <i class="fas fa-user me-1"></i>{{ customer.get_full_name|default:customer.username }}
                            </div>
                            <div class="customer-email">
                                <i class="fas fa-envelope me-1"></i>{{ customer.email }}
                            </div>
                            <div class="customer-date">
                                <i class="far fa-calendar me-1"></i>Joined {{ customer.date_joined|date:"M d, Y" }}
                            </div>
                            {% if customer.last_login %}
                            <div class="customer-date">
                                <i class="far fa-clock me-1"></i>Last login {{ customer.last_login|date:"M d, Y h:i A" }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="customer-stats">
                        <div class="stat-item">
                            <div class="stat-number">{{ customer.order_count|default:0 }}</div>
                            <div class="stat-label">Orders</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">â‚±{{ customer.total_spent|default_if_none:"0.00"|floatformat:2 }}</div>
                            <div class="stat-label">Total Spent</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">
                                {% if customer.is_active %}
                                    <i class="fas fa-check-circle text-success"></i>
                                {% else %}
                                    <i class="fas fa-times-circle text-danger"></i>
                                {% endif %}
                            </div>
                            <div class="stat-label">
                                {% if customer.is_active %}Active{% else %}Inactive{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h4>No Customers Found</h4>
                <p>There are no customers registered in the system yet.</p>
                <a class="btn btn-danger btn-lg" href="{% url 'admin_dashboard' %}">
                    <i class="fas fa-tachometer-alt me-2"></i>Back to Dashboard
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Search functionality (customers only)
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('customerSearch');
        const customerCards = document.querySelectorAll('.customer-card');

        function filterCustomers() {
            const searchTerm = (searchInput.value || '').toLowerCase();

            customerCards.forEach(card => {
                const name = (card.dataset.name || '').toLowerCase();
                const email = (card.dataset.email || '').toLowerCase();

                const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);

                card.style.display = matchesSearch ? 'block' : 'none';
            });

            const visibleCards = Array.from(customerCards).filter(card => card.style.display !== 'none');
            const customersContainer = document.querySelector('.customers-container');
            let emptyState = document.querySelector('.empty-state');

            if (visibleCards.length === 0 && customerCards.length > 0) {
                if (!emptyState) {
                    const newEmptyState = document.createElement('div');
                    newEmptyState.className = 'empty-state';
                    newEmptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <h4>No Customers Found</h4>
                        <p>No customers match your search criteria.</p>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear Search
                        </button>
                    `;
                    customersContainer.parentNode.appendChild(newEmptyState);
                    emptyState = newEmptyState;
                }
                customersContainer.style.display = 'none';
            } else {
                if (emptyState) {
                    emptyState.remove();
                }
                customersContainer.style.display = 'block';
            }
        }

        window.clearFilters = function() {
            searchInput.value = '';
            filterCustomers();
        }

        searchInput.addEventListener('input', filterCustomers);
    });
</script>
{% endblock %}
