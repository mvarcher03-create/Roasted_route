{% extends 'customer_base.html' %}

{% block title %}Order History - Roasted Route{% endblock %}
{% block nav_order_history_active %}active{% endblock %}
{% block page_header %}Order History{% endblock %}

{% block extra_head %}
    <style>
        :root { --red:#DC2626; --yellow:#F59E0B; --white:#fff; --gray-50:#F9FAFB; --gray-100:#F3F4F6; --gray-200:#E5E7EB; --gray-600:#4B5563; --gray-700:#374151; --gray-900:#111827; }

        .stats { display:flex; gap:12px; flex-wrap:wrap; }
        .stat { background:var(--white); border:1px solid var(--gray-100); border-radius:14px; padding:12px 16px; min-width:150px; text-align:center; }
        .stat .num { font-weight:800; font-size:1.5rem; color:var(--red); }
        .stat .lbl { color:var(--gray-600); font-size:.9rem; }

        .order-card { background:var(--white); border:1px solid var(--gray-100); border-radius:16px; padding:18px; box-shadow:0 10px 25px rgba(0,0,0,.06); }
        .order-header { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
        .order-id { font-weight:800; }
        .order-date { color:var(--gray-600); font-size:.95rem; }
        .badge-status { border-radius:999px; padding:6px 10px; font-weight:700; }
        .status-pending{ background:#fef3c7; color:#92400e; }
        .status-preparing{ background:#e0f2fe;color:#075985; }
        .status-ready{ background:#dcfce7;color:#065f46; }
        .status-out_for_delivery{ background:#e0e7ff;color:#3730a3; }
        .status-delivered,.status-completed{ background:#dcfce7;color:#065f46; }
        .status-cancelled{ background:#fee2e2;color:#991b1b; }

        .items-list { color:var(--gray-700); font-size:.95rem; }
        .items-list .addon { font-size:.85rem; color:#6b7280; }
        .total { font-weight:800; color:var(--red); font-size:1.2rem; }

        .action-btn { border-radius:10px; padding:.5rem .9rem; font-weight:700; }
    </style>
{% endblock %}

{% block content %}
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h2 class="m-0">Order History</h2>
            <div class="stats">
                <div class="stat"><div class="num">{{ stats.total }}</div><div class="lbl">Total Orders</div></div>
                <div class="stat"><div class="num">{{ stats.active }}</div><div class="lbl">Active</div></div>
                <div class="stat"><div class="num">{{ stats.completed }}</div><div class="lbl">Completed</div></div>
                <div class="stat"><div class="num">{{ stats.cancelled }}</div><div class="lbl">Cancelled</div></div>
            </div>
        </div>

        <form method="get" class="row g-2 mb-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label small mb-1">Search</label>
                <input type="text" name="q" value="{{ search_query }}" class="form-control form-control-sm" placeholder="Search by order # or item name">
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-1">Status</label>
                <select name="status" class="form-select form-select-sm" title="Filter orders by status">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-1">Date range</label>
                <select name="range" class="form-select form-select-sm" title="Filter orders by date range">
                    <option value="all" {% if date_range == 'all' %}selected{% endif %}>All time</option>
                    <option value="7" {% if date_range == '7' %}selected{% endif %}>Last 7 days</option>
                    <option value="30" {% if date_range == '30' %}selected{% endif %}>Last 30 days</option>
                </select>
            </div>
            <div class="col-md-2 text-md-end">
                <button type="submit" class="btn btn-danger btn-sm w-100 mt-3 mt-md-0">
                    <i class="fas fa-filter me-1"></i>Apply
                </button>
            </div>
        </form>

        {% if orders %}
            <div class="row g-3">
                {% for order in orders %}
                <div class="col-12">
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-id">Order #{{ order.id }} • {{ order.order_number }}</div>
                                <div class="order-date">{{ order.created_at|date:"M d, Y h:i A" }} • {{ order.delivery_type|title }}</div>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge-status status-{{ order.status }}">{{ order.get_status_display }}</span>
                                <div class="text-end">
                                    <div class="total">₱{{ order.computed_total|floatformat:2 }}</div>
                                    <div class="text-muted small">
                                        Items: ₱{{ order.items_subtotal|floatformat:2 }}{% if order.delivery_fee %} • Delivery: ₱{{ order.delivery_fee|floatformat:2 }}{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-3"/>
                        <div class="items-list">
                            {% for item in order.items.all %}
                                <div class="mb-1">
                                    <strong>{{ item.menu_item.name }}</strong> × {{ item.quantity }}
                                    <span class="text-muted">• ₱{{ item.unit_price|floatformat:2 }}</span>
                                    {% if item.customization.addOns or item.customization.addons %}
                                        <div class="addon">
                                            {% if item.customization.addOns %}
                                                {% for a in item.customization.addOns %}
                                                    • {{ a.label }}{% if a.price %} (+₱{{ a.price|floatformat:2 }}){% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            {% if item.customization.addons %}
                                                {% for a in item.customization.addons %}
                                                    • {{ a.label }}{% if a.price %} (+₱{{ a.price|floatformat:2 }}){% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    <div class="addon">
                                        Item total: ₱{{ item.total_price|floatformat:2 }} (Base ₱{{ item.base_total|floatformat:2 }}{% if item.addons_total %} + Add-ons ₱{{ item.addons_total|floatformat:2 }}{% endif %})
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <a href="{% url 'order_confirmation' orderz_id=order.id %}" class="btn btn-outline-secondary action-btn"><i class="fas fa-eye me-1"></i>View</a>
                            <form method="post" action="{% url 'reorder_order' order.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger action-btn">
                                    <i class="fas fa-redo me-1"></i>Reorder
                                </button>
                            </form>
                        </div>

                        {% if order.status == 'delivered' or order.status == 'completed' %}
                        <div class="mt-3">
                            {% if order.rating %}
                                <div class="small text-muted mb-1">Your rating:</div>
                                <div>
                                    {% for i in "12345"|make_list %}
                                        <i class="{% if forloop.counter <= order.rating %}fas{% else %}far{% endif %} fa-star text-warning"></i>
                                    {% endfor %}
                                    <span class="small text-muted ms-1">({{ order.rating }}/5)</span>
                                </div>
                                {% if order.review %}
                                <div class="small text-muted mt-1">“{{ order.review }}”</div>
                                {% endif %}
                            {% else %}
                                <form method="post" action="{% url 'rate_order' order.id %}" class="mt-2">
                                    {% csrf_token %}
                                    <div class="row g-2 align-items-center">
                                        <div class="col-auto">
                                            <span class="small">Rate this order:</span>
                                        </div>
                                        <div class="col-auto">
                                            <select name="rating" class="form-select form-select-sm" required title="Rate this order from 1 to 5 stars">
                                                <option value="" selected disabled>Stars</option>
                                                <option value="5">★★★★★ (5)</option>
                                                <option value="4">★★★★☆ (4)</option>
                                                <option value="3">★★★☆☆ (3)</option>
                                                <option value="2">★★☆☆☆ (2)</option>
                                                <option value="1">★☆☆☆☆ (1)</option>
                                            </select>
                                        </div>
                                        <div class="col-auto">
                                            <button type="submit" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-star me-1"></i>Submit rating
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <textarea name="review" class="form-control form-control-sm" rows="2" placeholder="Write a short review (optional)"></textarea>
                                    </div>
                                </form>
                            {% endif %}
                            <form method="post" action="{% url 'notify_admin_order_delivered' order.id %}" class="mt-2">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-bell me-1"></i>Notify admin that this order was delivered
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No orders yet</h4>
                <p class="text-muted">Browse our menu and make your first order.</p>
                <a class="btn btn-danger btn-lg" href="{% url 'order_now' %}"><i class="fas fa-utensils me-2"></i>Order Now</a>
            </div>
        {% endif %}
    </div>
{% endblock %}
